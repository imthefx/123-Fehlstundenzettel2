<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Meine Website</title>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 0;
  background:#f2f4f8;
  color:#111;
}

/* Darkmode */
body.dark-mode {
  background:#111;
  color:#f2f4f8;
}

nav {
  display: flex;
  gap: 15px;
  background: white;
  padding: 15px;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  position: fixed;
  top: 40px;
  left: 0;
  right: 0;
  align-items: center;
}

.nav-spacer {
  flex: 1;
}

.nav-auth-btn {
  margin-left: 8px;
  padding:7px 12px;
  background:#007bff;
  color:#fff;
  border:none;
  border-radius:5px;
  cursor:pointer;
  font-size:14px;
}
body.dark-mode .nav-auth-btn {
  background:#0056b3;
}

/* Auth-Modal */
.auth-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;              /* Start: unsichtbar */
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.auth-modal-content {
  background: #fff;
  padding: 20px;
  border-radius: 8px;
  max-width: 600px;
  width: 90%;
  max-height: 90vh;
  overflow-y: auto;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.auth-close {
  float: right;
  font-size: 24px;
  cursor: pointer;
}

/* Darkmode f√ºr Modal */
body.dark-mode .auth-modal-content {
  background:#222;
  color:#f2f4f8;
}


#navUserInfo {
  font-size: 14px;
  margin-right: 10px;
  opacity: 0.8;
}

#navAuthLink {
  text-decoration: none;
  font-weight: bold;
  margin-right: 10px;
}
nav a {
  text-decoration: none;
  color:#333;
  font-weight: bold;
}

#themeToggle {
  margin-left:auto;
  padding:7px 12px;
  background:#007bff;
  color:#fff;
  border-radius:5px;
  cursor:pointer;
  border:none;
  font-size:14px;
}

.section { padding: 120px 20px 20px 20px; max-width: 900px; margin:auto; }

.date-box {
  position: fixed;
  top: 5px;
  left: 5px;
  background: white;
  padding: 8px 12px;
  border-radius: 6px;
  font-weight: bold;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.card {
  background:white;
  padding:20px;
  border-radius:8px;
  margin-bottom:15px;
  box-shadow:0 2px 4px rgba(0,0,0,0.1);
}

input, textarea {
  width:100%;
  padding:10px;
  margin:8px 0;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:16px;
}
button {
  padding:10px 15px;
  background:#007bff;
  border:none;
  color:white;
  border-radius:6px;
  cursor:pointer;
}
button:hover { background:#0056b3; }

.chat-box {
  max-height:300px;
  overflow-y:auto;
  background:#fff;
  padding:10px;
  border-radius:8px;
}
.message {
  padding:5px 8px;
  margin-bottom:8px;
  background:#e9ecef;
  border-radius:5px;
}
.game-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }

/* TicTacToe */
.ttt-btn {
  width:60px;
  height:60px;
  font-size:26px;
}

/* Snake */
canvas { border: 1px solid #ccc; }

/* Darkmode f√ºr Elemente */
body.dark-mode nav,
body.dark-mode .card,
body.dark-mode .date-box,
body.dark-mode .chat-box {
  background:#222;
  color:#f2f4f8;
}
body.dark-mode nav a { color:#f2f4f8; }

body.dark-mode input,
body.dark-mode textarea {
  background:#333;
  color:#f2f4f8;
  border-color:#555;
}
body.dark-mode .message {
  background:#444;
  color:#fff;
}
</style>
</head>

<body>

<!-- Datum -->
<div class="date-box" id="dateBox"></div>

<!-- Navigation -->
<nav>
  <a href="#pdfs">PDFs</a>
  <a href="#games">Spiele</a>
  <a href="#news">News</a>
  <a href="#chat">Live-Chat</a>

  <div class="nav-spacer"></div>

  <span id="navUserInfo">Nicht eingeloggt</span>
  <button class="nav-auth-btn" onclick="openAuthModal('login')">Login</button>
  <button class="nav-auth-btn" onclick="openAuthModal('register')">Registrieren</button>

  <button id="themeToggle">Darkmode</button>
</nav>



<!-- USER SYSTEM als POPUP -->
<div id="authModal" class="auth-modal">
  <div class="auth-modal-content">
    <span class="auth-close" onclick="closeAuthModal()">&times;</span>
    <h1>Benutzerkonto</h1>

    <div class="card">
      <h2>Registrieren</h2>
      <input id="regEmail" type="text" placeholder="E-Mail">
      <input id="regPass" type="password" placeholder="Passwort">
      <input id="regNick" type="text" placeholder="Nickname (einzigartig)">
      <button onclick="register()">Konto erstellen</button>
    </div>

    <div class="card">
      <h2>Login</h2>
      <input id="logEmail" type="text" placeholder="E-Mail">
      <input id="logPass" type="password" placeholder="Passwort">
      <button onclick="login()">Login</button>
      <button onclick="logout()">Logout</button>
      <p id="userState"></p>
    </div>
  </div>
</div>


<!-- PDFs -->
<div id="pdfs" class="section">
  <h1>Formulare / PDFs</h1>

  <div class="card">
    <h3>Hochgeladene Dateien</h3>
    <div id="pdfList">Wird geladen...</div>
  </div>


<!-- Spiele -->
<div id="games" class="section">
  <h1>Spiele</h1>
  <div class="game-grid">

    <!-- TicTacToe -->
    <div class="card">
      <h3>Tic Tac Toe</h3>
      <div id="tttBoard" style="display:grid;grid-template-columns:repeat(3,1fr);gap:5px;"></div>
      <p id="tttStatus"></p>
      <button onclick="resetTTT()">Neu starten</button>
    </div>

        <!-- Snake -->
    <div class="card">
      <h3>Snake</h3>
      <canvas id="snakeCanvas" width="320" height="320"></canvas><br>
      <button onclick="startSnake()">Start</button>
      <button onclick="pauseSnake()">Pause</button>
      <button onclick="resetSnake()">Neu</button>
      <button onclick="openSnakeRanking()">Rangliste</button>

      <!-- Score-Anzeige -->
      <div style="margin-top:8px;">
        <span>Score: <strong id="snakeScore">0</strong></span>
        <span style="margin-left:12px;">Highscore (local): <strong id="snakeHighLocal">0</strong></span>
        <span style="margin-left:12px;">Highscore (global): <strong id="snakeHighGlobal">0</strong></span>
      </div>

      <p>Steuerung: W A S D</p>
    </div>

    <!-- Snake Ranking Modal -->
    <div id="snakeRankingModal" class="auth-modal">
      <div class="auth-modal-content">
        <span class="auth-close" onclick="closeSnakeRanking()">&times;</span>
        <h2>üèÜ Snake Rangliste (Top 10)</h2>
        <div id="snakeRankingList" style="max-height:400px; overflow-y:auto;"></div>
      </div>
    </div>

  </div>
</div>

<!-- News -->
<div id="news" class="section">
  <h1>News</h1>
  <div id="newsList"></div>

  <!-- News posten ‚Äì nur Admin sieht diese Karte -->
  <div class="card" id="newsAdminCard" style="display:none;">
    <h2>News schreiben (nur Admin)</h2>
    <p>Absender: <strong>imthefx</strong></p>
    <input type="text" id="newsTitle" placeholder="Titel">
    <textarea id="newsContent" placeholder="Inhalt"></textarea>
    <button onclick="postNews()">Posten</button>
  </div>
</div>

<!-- Live Chat -->
<div id="chat" class="section">
  <h1>Live Chat</h1>

  <p id="chatInfo">Bitte einloggen, um zu schreiben.</p>

  <div class="chat-box" id="chatMessages"></div>

  <!-- Name-Feld entfernt ‚Äì Nickname kommt automatisch vom Benutzerkonto -->
  <textarea id="chatText" placeholder="Nachricht"></textarea>
  <button onclick="sendMessage()">Absenden</button>
</div>

<!-- Firebase & Main Script -->
<script type="module">
/////////////////////////////////////////////////////////////////////////////
// Firebase Setup
/////////////////////////////////////////////////////////////////////////////

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged,
  createUserWithEmailAndPassword
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  serverTimestamp,
  query,
  orderBy,
  onSnapshot,
  doc,
  setDoc,
  getDoc,
  where,
  getDocs,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytesResumable,
  getDownloadURL,
  listAll
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// Firebase-Konfiguration
const firebaseConfig = {
  apiKey: "AIzaSyAeC7Nt3ElB4KdCei-g19syTsF8hSoccSI",
  authDomain: "fehlstundenzettel.firebaseapp.com",
  projectId: "fehlstundenzettel",
  storageBucket: "fehlstundenzettel.firebasestorage.app",
  messagingSenderId: "95765743506",
  appId: "1:95765743506:web:05f5305b6d7c56ba0a234b",
  measurementId: "G-QWEBRN16HW"
};

// Admin E-Mail (f√ºr News & PDF-Upload)
const ADMIN_EMAIL = "felixhorschke19@gmail.com";

// Firebase initialisieren
const app = initializeApp(firebaseConfig);
const auth = getAuth();
const db = getFirestore();
const storage = getStorage();

// globaler User/Nickname
let currentUser = null;
let currentNickname = null;

/////////////////////////////////////////////////////////////////////////////
// Darkmode
/////////////////////////////////////////////////////////////////////////////
const themeToggle = document.getElementById("themeToggle");

function applyTheme(theme) {
  if (theme === "dark") {
    document.body.classList.add("dark-mode");
    themeToggle.textContent = "Whitemode";
  } else {
    document.body.classList.remove("dark-mode");
    themeToggle.textContent = "Darkmode";
  }
}

const savedTheme = localStorage.getItem("theme") || "light";
applyTheme(savedTheme);

themeToggle.addEventListener("click", () => {
  const newTheme = document.body.classList.contains("dark-mode") ? "light" : "dark";
  applyTheme(newTheme);
  localStorage.setItem("theme", newTheme);
});

/////////////////////////////////////////////////////////////////////////////
// Auth-Modal √∂ffnen / schlie√üen
/////////////////////////////////////////////////////////////////////////////
window.openAuthModal = function(mode) {
  const modal = document.getElementById("authModal");
  if (!modal) return;
  modal.style.display = "flex";

  // optional Fokus setzen
  if (mode === "login") {
    const el = document.getElementById("logEmail");
    if (el) el.focus();
  } else {
    const el = document.getElementById("regEmail");
    if (el) el.focus();
  }
};

window.closeAuthModal = function() {
  const modal = document.getElementById("authModal");
  if (!modal) return;
  modal.style.display = "none";
};

// Klick auf dunklen Hintergrund schlie√üt Modal
const authModalEl = document.getElementById("authModal");
if (authModalEl) {
  authModalEl.addEventListener("click", (e) => {
    if (e.target === authModalEl) {
      window.closeAuthModal();
    }
  });
}

// ESC schlie√üt Modal
document.addEventListener("keydown", (e) => {
  if (e.key === "Escape") {
    window.closeAuthModal();
  }
});


/////////////////////////////////////////////////////////////////////////////
// Datum
/////////////////////////////////////////////////////////////////////////////
function updateDate() {
  document.getElementById("dateBox").textContent =
    new Date().toLocaleDateString("de-DE");
}
updateDate();

/////////////////////////////////////////////////////////////////////////////
// User-System: Registrierung / Login
/////////////////////////////////////////////////////////////////////////////
window.register = async function() {
  const email = document.getElementById("regEmail").value.trim();
  const pass = document.getElementById("regPass").value.trim();
  const nick = document.getElementById("regNick").value.trim();

  if (!email || !pass || !nick) {
    alert("Bitte E-Mail, Passwort und Nickname eingeben.");
    return;
  }

  // pr√ºfen, ob Nickname schon existiert
  const usersRef = collection(db, "users");
  const q = query(usersRef, where("nickname", "==", nick));
  const snap = await getDocs(q);

  if (!snap.empty) {
    alert("Nickname ist bereits vergeben. Bitte einen anderen w√§hlen.");
    return;
  }

  try {
    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await setDoc(doc(db, "users", cred.user.uid), {
      email,
      nickname: nick,
      createdAt: serverTimestamp()
    });
    alert("Konto erstellt. Du bist jetzt eingeloggt.");
  } catch (err) {
    alert("Registrierung fehlgeschlagen: " + err.message);
  }
};

window.login = async function() {
  const email = document.getElementById("logEmail").value.trim();
  const pass = document.getElementById("logPass").value.trim();
  if (!email || !pass) {
    alert("Bitte E-Mail und Passwort eingeben.");
    return;
  }
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch (err) {
    alert("Login fehlgeschlagen: " + err.message);
  }
};

window.logout = async function() {
  await signOut(auth);
};

onAuthStateChanged(auth, async user => {
  currentUser = user || null;
  const userState = document.getElementById("userState");
  const chatInfo = document.getElementById("chatInfo");
  const newsAdminCard = document.getElementById("newsAdminCard");
  const navUserInfo = document.getElementById("navUserInfo");
  const authModal = document.getElementById("authModal");
  const pdfUploadCard = document.getElementById("pdfUploadCard");

  if (user) {
    const userDoc = await getDoc(doc(db, "users", user.uid));
    currentNickname = userDoc.exists() ? userDoc.data().nickname : user.email;

    if (userState)
      userState.textContent = "Eingeloggt als: " + currentNickname + " (" + user.email + ")";
    if (chatInfo)
      chatInfo.textContent = "Du schreibst als: " + currentNickname;
    if (navUserInfo)
      navUserInfo.textContent = "Angemeldet: " + currentNickname;

    // News-Formular nur Admin
    if (user.email === ADMIN_EMAIL) {
      if (newsAdminCard) newsAdminCard.style.display = "block";
      if (pdfUploadCard) pdfUploadCard.style.display = "block";   // ‚úÖ Upload nur f√ºr Admin sichtbar
    } else {
      if (newsAdminCard) newsAdminCard.style.display = "none";
      if (pdfUploadCard) pdfUploadCard.style.display = "none";
    }

    if (authModal) authModal.style.display = "none";
  } else {
    currentNickname = null;
    if (userState) userState.textContent = "Nicht eingeloggt.";
    if (chatInfo) chatInfo.textContent = "Bitte einloggen, um zu schreiben.";
    if (navUserInfo) navUserInfo.textContent = "Nicht eingeloggt";
    if (newsAdminCard) newsAdminCard.style.display = "none";
    if (pdfUploadCard) pdfUploadCard.style.display = "none";
  }
});


/////////////////////////////////////////////////////////////////////////////
// PDF-Liste laden (ohne Firebase Storage, Dateien aus GitHub / eingebettet)
/////////////////////////////////////////////////////////////////////////////
const embeddedFiles = {
  // Beispiel: erstelle im Repo einen Ordner "files" und lade Dateien hoch.
  // Ersetze /files/MeinFormular.pdf mit echten Dateinamen aus deinem Repo.
  "123Fehlstundenzettel.pdf": "https://github.com/imthefx/123-Fehlstundenzettel/blob/main/123Fehlstundenzettel.pdf"
};

async function loadPDFs() {
  const listEl = document.getElementById("pdfList");
  let html = "";

  for (const [filename, url] of Object.entries(embeddedFiles)) {
    html += `<p><a href="${url}" target="_blank" download="${filename}">${filename}</a></p>`;
  }

  if (!html) html = "<p>Keine Dateien vorhanden.</p>";
  listEl.innerHTML = html;
}
loadPDFs();


/////////////////////////////////////////////////////////////////////////////
// PDF Upload (nur Admin)
/////////////////////////////////////////////////////////////////////////////
window.uploadPDF = async function() {
  if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) {
    alert("Nur Admin darf Dateien hochladen!");
    return;
  }

  const input = document.getElementById("pdfUpload");
  const files = input.files;

  if (!files || files.length === 0) {
    alert("Keine Datei ausgew√§hlt.");
    return;
  }

  const progressContainer = document.getElementById("uploadProgressContainer");
  const progressBar = document.getElementById("uploadBar");
  const progressPercent = document.getElementById("uploadPercent");

  progressContainer.style.display = "block";

  let uploadedCount = 0;
  const totalFiles = files.length;

  for (const file of files) {
    const storageRef = ref(storage, "pdfs/" + file.name);
    const uploadTask = uploadBytesResumable(storageRef, file);
    
    try {
      // Warte bis Upload komplett ist
      await new Promise((resolve, reject) => {
        uploadTask.on(
          "state_changed",
          (snapshot) => {
            // State_changed wird mehrmals aufgerufen
            const bytesTransferred = snapshot.bytesTransferred;
            const totalBytes = snapshot.totalBytes;
            
            console.log(`Datei: ${file.name} - ${bytesTransferred}/${totalBytes}`);
            
            const fileProgress = (bytesTransferred / totalBytes) * 100;
            const totalProgress = ((uploadedCount + fileProgress / 100) / totalFiles) * 100;
            
            progressPercent.textContent = Math.round(totalProgress);
            progressBar.style.width = Math.round(totalProgress) + "%";
          },
          (error) => {
            console.error("Upload Fehler:", error);
            reject(error);
          },
          () => {
            // Complete
            console.log(`${file.name} fertig!`);
            uploadedCount++;
            resolve();
          }
        );
      });
      
    } catch (err) {
      alert("Fehler beim Upload von " + file.name + ": " + err.message);
    }
  }

  alert("Datei(en) hochgeladen!");
  input.value = "";
  progressContainer.style.display = "none";
  progressPercent.textContent = "0";
  progressBar.style.width = "0%";
  
  loadPDFs();
};

/////////////////////////////////////////////////////////////////////////////
// NEWS LADEN
/////////////////////////////////////////////////////////////////////////////
function loadNews() {
  const qNews = query(collection(db, "news"), orderBy("createdAt", "desc"));
  const listEl = document.getElementById("newsList");

  onSnapshot(qNews, snap => {
    let html = "";
    snap.forEach(docu => {
      const d = docu.data();
      const date = d.createdAt?.toDate?.() || new Date();
      html += `
        <div class="card">
          <h3>${d.title}</h3>
          <small>${d.author} ‚Äî ${date.toLocaleString()}</small>
          <p>${d.content}</p>
        </div>
      `;
    });
    if (!html) html = "<p>Noch keine News.</p>";
    listEl.innerHTML = html;
  });
}
loadNews();

/////////////////////////////////////////////////////////////////////////////
// NEWS POSTEN (nur Admin)
/////////////////////////////////////////////////////////////////////////////
window.postNews = async function() {
  if (!auth.currentUser || auth.currentUser.email !== ADMIN_EMAIL) {
    alert("Nur Admin darf News posten!");
    return;
  }

  const title = document.getElementById("newsTitle").value.trim();
  const content = document.getElementById("newsContent").value.trim();
  if (!title || !content) {
    alert("Bitte Titel und Inhalt eingeben.");
    return;
  }

  await addDoc(collection(db, "news"), {
    title,
    content,
    author: ADMIN_EMAIL,
    createdAt: serverTimestamp()
  });

  document.getElementById("newsTitle").value = "";
  document.getElementById("newsContent").value = "";

  alert("News ver√∂ffentlicht!");
};

/////////////////////////////////////////////////////////////////////////////
// CHAT
/////////////////////////////////////////////////////////////////////////////
function loadChat() {
  const qChat = query(collection(db, "chat"), orderBy("createdAt", "asc"));
  const msgBox = document.getElementById("chatMessages");

  onSnapshot(qChat, snap => {
    let html = "";
    snap.forEach(docu => {
      const m = docu.data();
     html += `
  <div class="message">
    <strong>${m.nickname || "Unbekannt"}</strong>
    <span style="float:right; font-size:12px; opacity:0.7;">
      ${m.createdAt?.toDate?.().toLocaleDateString("de-DE")} 
      ${m.createdAt?.toDate?.().toLocaleTimeString("de-DE", { hour: "2-digit", minute: "2-digit" })}
    </span>
    <br>
    ${m.text}
  </div>
`;
    });
    msgBox.innerHTML = html;
    msgBox.scrollTop = msgBox.scrollHeight;
  });
}
loadChat();

window.sendMessage = async function() {
  const text = document.getElementById("chatText").value.trim();
  if (!text) return alert("Bitte eine Nachricht eingeben.");
  if (!currentUser || !currentNickname) {
    alert("Bitte zuerst einloggen. Der Chat nutzt deinen Nickname.");
    return;
  }

  await addDoc(collection(db, "chat"), {
    uid: currentUser.uid,
    nickname: currentNickname,
    text,
    createdAt: serverTimestamp()
  });

  document.getElementById("chatText").value = "";

  // Limit auf 25 Nachrichten pr√ºfen
  await cleanupOldMessages();
};

// Funktion: L√∂scht alte Nachrichten wenn mehr als 25 vorhanden sind
async function cleanupOldMessages() {
  const qCount = query(collection(db, "chat"), orderBy("createdAt", "asc"));
  const snap = await getDocs(qCount);
  
  const MAX_MESSAGES = 25;
  
  // Wenn mehr als 25 Nachrichten, l√∂sche die √§ltesten
  if (snap.docs.length > MAX_MESSAGES) {
    const toDelete = snap.docs.length - MAX_MESSAGES;
    
    for (let i = 0; i < toDelete; i++) {
      await deleteDoc(snap.docs[i].ref);
    }
  }
}

/////////////////////////////////////////////////////////////////////////////
// TicTacToe
/////////////////////////////////////////////////////////////////////////////
let tttBoard = Array(9).fill(null);
let tttXturn = true;

function drawTTT() {
  const box = document.getElementById("tttBoard");
  box.innerHTML = "";
  tttBoard.forEach((cell, i) => {
    const btn = document.createElement("button");
    btn.textContent = cell || "";
    btn.className = "ttt-btn";
    btn.onclick = () => tttClick(i);
    box.appendChild(btn);
  });

  const w = tttWinner(tttBoard);
  document.getElementById("tttStatus").textContent =
    w ? "Gewinner: " + w : "N√§chster Spieler: " + (tttXturn ? "X" : "O");
}

function tttClick(i) {
  if (tttBoard[i] || tttWinner(tttBoard)) return;
  tttBoard[i] = tttXturn ? "X" : "O";
  tttXturn = !tttXturn;
  drawTTT();
}

function tttWinner(b) {
  const lines = [
    [0,1,2],[3,4,5],[6,7,8],
    [0,3,6],[1,4,7],[2,5,8],
    [0,4,8],[2,4,6]
  ];
  for (let l of lines) {
    const [a,b1,c] = l;
    if (b[a] && b[a] === b[b1] && b[a] === b[c]) return b[a];
  }
  return null;
}

window.resetTTT = function() {
  tttBoard = Array(9).fill(null);
  tttXturn = true;
  drawTTT();
};

drawTTT();

/////////////////////////////////////////////////////////////////////////////
// Snake
/////////////////////////////////////////////////////////////////////////////
const canvas = document.getElementById("snakeCanvas");
const ctx = canvas.getContext("2d");

let snake = [{x:8,y:8}];
let dir = {x:1,y:0};
let food = randFood();
let snakeRunning = false;

// Score / Highscores
let score = 0;
let highLocal = parseInt(localStorage.getItem("snakeHighLocal") || "0", 10) || 0;
let highGlobal = 0;

// DOM-Elemente
const snakeScoreEl = document.getElementById("snakeScore");
const snakeHighLocalEl = document.getElementById("snakeHighLocal");
const snakeHighGlobalEl = document.getElementById("snakeHighGlobal");

// Init Anzeige
if (snakeScoreEl) snakeScoreEl.textContent = score;
if (snakeHighLocalEl) snakeHighLocalEl.textContent = highLocal;
if (snakeHighGlobalEl) snakeHighGlobalEl.textContent = highGlobal;

function randFood() {
  return {x: Math.floor(Math.random()*16), y: Math.floor(Math.random()*16)};
}

function updateScoreDisplays() {
  if (snakeScoreEl) snakeScoreEl.textContent = score;
  if (snakeHighLocalEl) snakeHighLocalEl.textContent = highLocal;
  if (snakeHighGlobalEl) snakeHighGlobalEl.textContent = highGlobal;
}

async function updateGlobalHighscore() {
  try {
    const snap = await getDocs(collection(db, "snakeScores"));
    let max = 0;
    snap.forEach(d => {
      const s = d.data().score || 0;
      if (s > max) max = s;
    });
    highGlobal = max;
    updateScoreDisplays();
  } catch (err) {
    console.error("Fehler globaler Highscore:", err);
  }
}

updateGlobalHighscore();

function loopSnake() {
  if (!snakeRunning) return;

  const head = {x: snake[0].x + dir.x, y: snake[0].y + dir.y};

  if (head.x<0||head.x>=16||head.y<0||head.y>=16 || snake.some(s=>s.x===head.x && s.y===head.y)) {
    snakeRunning = false;
    gameOver();
    return;
  }

  snake.unshift(head);
  if (head.x === food.x && head.y === food.y) {
    // gegessen -> Score erh√∂hen, neues Futter
    score++;
    updateScoreDisplays();
    food = randFood();
  } else {
    snake.pop();
  }

  drawSnake();
}

function drawSnake() {
  const isDark = document.body.classList.contains("dark-mode");
  ctx.fillStyle = isDark ? "#000" : "#fff";
  ctx.fillRect(0,0,320,320);

  ctx.fillStyle = "red";
  ctx.fillRect(food.x*20, food.y*20, 18, 18);

  ctx.fillStyle = "green";
  snake.forEach(s => {
    ctx.fillRect(s.x*20, s.y*20, 18, 18);
  });

  // Score im Canvas optional anzeigen (bereits im DOM)
}

function resetSnakeInternal() {
  snake = [{x:8,y:8}];
  dir = {x:1,y:0};
  food = randFood();
  snakeRunning = false;
  score = 0;
  updateScoreDisplays();
  drawSnake();
}

window.startSnake = function() {
  // Start-Button startet immer neu
  resetSnakeInternal();
  snakeRunning = true;
};

window.pauseSnake = function() { snakeRunning = false; };
window.resetSnake = function() { resetSnakeInternal(); };

document.addEventListener("keydown", e => {
  const k = e.key.toLowerCase();
  if (k==="w" && dir.y!==1) dir={x:0,y:-1};
  if (k==="s" && dir.y!==-1) dir={x:0,y:1};
  if (k==="a" && dir.x!==1) dir={x:-1,y:0};
  if (k==="d" && dir.x!==-1) dir={x:1,y:0};
});

setInterval(loopSnake, 120);
drawSnake();

async function gameOver() {
  // Lokalen Highscore pr√ºfen/aktualisieren
  if (score > highLocal) {
    highLocal = score;
    try { localStorage.setItem("snakeHighLocal", String(highLocal)); } catch(e){}
  }

  updateScoreDisplays();

  // Globalen Score in Firestore speichern (falls m√∂glich)
  try {
    await addDoc(collection(db, "snakeScores"), {
      score,
      nickname: currentNickname || "guest",
      createdAt: serverTimestamp()
    });
  } catch (err) {
    console.warn("Konnte globalen Score nicht speichern:", err);
  }

  // Globalen Highscore neu laden
  await updateGlobalHighscore();

  alert("Game Over! Dein Score: " + score);
}

/////////////////////////////////////////////////////////////////////////////
// Snake Ranking Modal
/////////////////////////////////////////////////////////////////////////////
window.openSnakeRanking = async function() {
  const modal = document.getElementById("snakeRankingModal");
  if (!modal) return;
  
  // Lade Rankings
  await loadSnakeRankings();
  
  modal.style.display = "flex";
};

window.closeSnakeRanking = function() {
  const modal = document.getElementById("snakeRankingModal");
  if (!modal) return;
  modal.style.display = "none";
};

// Klick auf Modal-Hintergrund schlie√üt es
const snakeRankingModalEl = document.getElementById("snakeRankingModal");
if (snakeRankingModalEl) {
  snakeRankingModalEl.addEventListener("click", (e) => {
    if (e.target === snakeRankingModalEl) {
      window.closeSnakeRanking();
    }
  });
}

async function loadSnakeRankings() {
  const listEl = document.getElementById("snakeRankingList");
  listEl.innerHTML = "<p>Wird geladen...</p>";
  
  try {
    const snap = await getDocs(collection(db, "snakeScores"));
    
    // Sortiere nach Score (absteigend) und nimm Top 10
    const scores = [];
    snap.forEach(d => {
      scores.push({
        nickname: d.data().nickname || "guest",
        score: d.data().score || 0,
        date: d.data().createdAt?.toDate?.() || new Date()
      });
    });
    
    scores.sort((a, b) => b.score - a.score);
    const top10 = scores.slice(0, 10);
    
    if (top10.length === 0) {
      listEl.innerHTML = "<p>Noch keine Scores vorhanden.</p>";
      return;
    }
    
    // Dark-Mode Check
    const isDark = document.body.classList.contains("dark-mode");
    const headerBg = "#007bff";
    const headerText = "#fff";
    const rowBg1 = isDark ? "#333" : "#f9f9f9";
    const rowBg2 = isDark ? "#222" : "#fff";
    const textColor = isDark ? "#f2f4f8" : "#111";
    const borderColor = isDark ? "#555" : "#ddd";
    
    let html = `<table style='width:100%; border-collapse:collapse; color:${textColor};'>`;
    html += `<tr style='background:${headerBg}; color:${headerText};'><th style='padding:10px;'>#</th><th style='padding:10px;'>Nickname</th><th style='padding:10px;'>Score</th><th style='padding:10px;'>Datum</th></tr>`;
    
    top10.forEach((item, idx) => {
      const bgColor = idx % 2 === 0 ? rowBg1 : rowBg2;
      const medal = idx === 0 ? "ü•á" : idx === 1 ? "ü•à" : idx === 2 ? "ü•â" : "";
      html += `
        <tr style="background:${bgColor}; border-bottom:1px solid ${borderColor}; color:${textColor};">
          <td style="padding:10px; text-align:center;">${medal} ${idx + 1}</td>
          <td style="padding:10px;">${item.nickname}</td>
          <td style="padding:10px; font-weight:bold;">${item.score}</td>
          <td style="padding:10px; font-size:12px;">${item.date.toLocaleDateString("de-DE")}</td>
        </tr>
      `;
    });
    
    html += "</table>";
    listEl.innerHTML = html;
    
  } catch (err) {
    console.error("Fehler beim Laden der Rankings:", err);
    listEl.innerHTML = "<p>Fehler beim Laden der Rankings.</p>";
  }
}

/////////////////////////////////////////////////////////////////////////////

/////////////////////////////////////////////////////////////////////////////
</script>

</body>
</html>
